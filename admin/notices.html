<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³µì§€ ê´€ë¦¬ - CASHiQ Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <nav class="bg-gradient-to-r from-purple-600 to-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <a href="dashboard.html" class="text-white hover:text-gray-200">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </a>
                    <div>
                        <h1 class="text-xl font-bold">ê³µì§€ ê´€ë¦¬</h1>
                        <p class="text-sm opacity-90">Notice Management</p>
                    </div>
                </div>
                <button onclick="logout()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition">
                    <i class="fas fa-sign-out-alt mr-1"></i>ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- Add Notice Form -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-plus-circle text-blue-600 mr-2"></i>
                    <span id="formTitle">ê³µì§€ ë“±ë¡</span>
                </h2>
                <div class="text-right">
                    <p class="text-sm text-gray-600">í˜„ì¬ ê³µì§€ ìˆ˜</p>
                    <p class="text-2xl font-bold text-blue-600"><span id="currentNoticeCount">0</span>/50</p>
                </div>
            </div>
            
            <form id="noticeForm" class="space-y-4">
                <input type="hidden" id="noticeId">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ì œëª© <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="title" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ì¹´í…Œê³ ë¦¬ <span class="text-red-500">*</span>
                        </label>
                        <select id="category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="service">ì„œë¹„ìŠ¤ ì•ˆë‚´</option>
                            <option value="maintenance">ì‹œìŠ¤í…œ ì ê²€</option>
                            <option value="event">ì´ë²¤íŠ¸/í”„ë¡œëª¨ì…˜</option>
                            <option value="policy">ë²•ë ¹Â·ì •ì±… ë³€ê²½</option>
                            <option value="emergency">ê¸´ê¸‰(ì‘ê¸‰) ì•ˆë‚´</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ì–¸ì–´ <span class="text-red-500">*</span>
                        </label>
                        <select id="lang" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="ko">í•œêµ­ì–´</option>
                            <option value="en">English</option>
                            <option value="zh">ä¸­æ–‡</option>
                            <option value="ja">æ—¥æœ¬èª</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ì¤‘ìš”ë„ <span class="text-red-500">*</span>
                        </label>
                        <select id="importance" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="normal">ì¼ë°˜</option>
                            <option value="important">ì¤‘ìš”</option>
                            <option value="urgent">ê¸´ê¸‰</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        í•œì¤„ ìš”ì•½
                    </label>
                    <input type="text" id="summary" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="ê°„ë‹¨í•œ ìš”ì•½ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ë‚´ìš© <span class="text-red-500">*</span>
                    </label>
                    <textarea id="content" required rows="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                </div>

                <!-- Image Upload -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-image mr-2 text-blue-600"></i>ì´ë¯¸ì§€ ì—…ë¡œë“œ
                    </label>
                    <input type="file" id="imageFile" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <input type="hidden" id="imageUrl">
                    <div id="imagePreview" class="mt-2 hidden">
                        <img id="previewImg" class="max-w-xs rounded-lg shadow-md" alt="ë¯¸ë¦¬ë³´ê¸°">
                        <button type="button" onclick="removeImage()" class="mt-2 text-sm text-red-600 hover:text-red-800">
                            <i class="fas fa-times mr-1"></i>ì´ë¯¸ì§€ ì œê±°
                        </button>
                    </div>
                </div>

                <!-- Video Upload -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-video mr-2 text-red-600"></i>ë™ì˜ìƒ ì—…ë¡œë“œ
                    </label>
                    
                    <!-- Tab Buttons -->
                    <div class="flex space-x-2 mb-3">
                        <button type="button" id="videoFileTabBtn" onclick="switchVideoTab('file')" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg transition">
                            <i class="fas fa-upload mr-1"></i>íŒŒì¼ ì—…ë¡œë“œ
                        </button>
                        <button type="button" id="videoUrlTabBtn" onclick="switchVideoTab('url')" class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                            <i class="fas fa-link mr-1"></i>YouTube URL
                        </button>
                    </div>
                    
                    <!-- File Upload Tab -->
                    <div id="videoFileTab">
                        <input type="file" id="videoFile" accept="video/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100">
                        <p class="mt-1 text-xs text-gray-500">MP4, WebM, AVI í˜•ì‹ ì§€ì› (ìµœëŒ€ 10MB)</p>
                        <input type="hidden" id="videoFileUrl">
                        <div id="videoFilePreview" class="mt-2 hidden">
                            <video id="previewVideo" class="max-w-md rounded-lg shadow-md" controls>
                                <source id="videoSource" type="video/mp4">
                                ë¸Œë¼ìš°ì €ê°€ ë™ì˜ìƒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                            </video>
                            <button type="button" onclick="removeVideo()" class="mt-2 text-sm text-red-600 hover:text-red-800">
                                <i class="fas fa-times mr-1"></i>ë™ì˜ìƒ ì œê±°
                            </button>
                        </div>
                    </div>
                    
                    <!-- URL Tab -->
                    <div id="videoUrlTab" class="hidden">
                        <input type="text" id="videoUrl" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="https://youtu.be/xxxxx ë˜ëŠ” https://www.youtube.com/watch?v=xxxxx">
                        <p class="mt-1 text-xs text-gray-500">YouTube ë™ì˜ìƒ ë§í¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ì‹œì‘ì¼
                        </label>
                        <input type="datetime-local" id="startDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ì¢…ë£Œì¼
                        </label>
                        <input type="datetime-local" id="endDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="pinned" class="mr-2 w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                        <span class="text-sm font-medium text-gray-700">ìƒë‹¨ ê³ ì •</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="active" checked class="mr-2 w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                        <span class="text-sm font-medium text-gray-700">í™œì„±í™”</span>
                    </label>
                </div>

                <div class="flex space-x-4">
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                        <i class="fas fa-save mr-2"></i>ì €ì¥
                    </button>
                    <button type="button" onclick="resetForm()" class="px-6 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400 transition">
                        <i class="fas fa-times mr-2"></i>ì·¨ì†Œ
                    </button>
                </div>
            </form>
        </div>

        <!-- Notice List -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">
                <i class="fas fa-list text-blue-600 mr-2"></i>ê³µì§€ ëª©ë¡
            </h2>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì œëª©</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì¹´í…Œê³ ë¦¬</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì¤‘ìš”ë„</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì–¸ì–´</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ì‘ì„±ì¼</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ìƒíƒœ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="noticeTableBody" class="divide-y divide-gray-200">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Check authentication
        function checkAuth() {
            const loggedIn = sessionStorage.getItem('adminLoggedIn');
            if (!loggedIn) {
                window.location.href = 'index.html';
                return false;
            }
            return true;
        }

        function logout() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }

        let notices = [];

        // Load notices
        async function loadNotices() {
            try {
                const response = await fetch('../data/notices.json');
                notices = await response.json();
                renderNotices();
            } catch (error) {
                console.error('Error loading notices:', error);
                notices = [];
            }
        }

        // Render notices table
        function renderNotices() {
            const tbody = document.getElementById('noticeTableBody');
            
            // Update count display
            const countElement = document.getElementById('currentNoticeCount');
            if (countElement) {
                countElement.textContent = notices.length;
                // Change color based on usage
                const percentage = (notices.length / 50) * 100;
                if (percentage >= 90) {
                    countElement.classList.add('text-red-600');
                    countElement.classList.remove('text-blue-600', 'text-yellow-600');
                } else if (percentage >= 70) {
                    countElement.classList.add('text-yellow-600');
                    countElement.classList.remove('text-blue-600', 'text-red-600');
                } else {
                    countElement.classList.add('text-blue-600');
                    countElement.classList.remove('text-yellow-600', 'text-red-600');
                }
            }
            
            if (notices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">ë“±ë¡ëœ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            // Sort by pinned and date
            const sortedNotices = [...notices].sort((a, b) => {
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;
                return new Date(b.createdAt) - new Date(a.createdAt);
            });

            tbody.innerHTML = sortedNotices.map(notice => `
                <tr class="hover:bg-gray-50 ${notice.pinned ? 'bg-yellow-50' : ''}">
                    <td class="px-4 py-3">
                        ${notice.pinned ? '<i class="fas fa-thumbtack text-yellow-600 mr-2"></i>' : ''}
                        <span class="font-medium">${notice.title}</span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs rounded ${getCategoryColor(notice.category)}">
                            ${getCategoryText(notice.category)}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs rounded ${getImportanceColor(notice.importance)}">
                            ${getImportanceText(notice.importance)}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm">${getLangText(notice.lang)}</td>
                    <td class="px-4 py-3 text-sm">${formatDate(notice.createdAt)}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 text-xs rounded ${notice.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${notice.active ? 'í™œì„±' : 'ë¹„í™œì„±'}
                        </span>
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex space-x-2">
                            <button onclick="editNotice(${notice.id})" class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteNotice(${notice.id})" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function getCategoryColor(category) {
            const colors = {
                service: 'bg-blue-100 text-blue-800',
                maintenance: 'bg-orange-100 text-orange-800',
                event: 'bg-green-100 text-green-800',
                policy: 'bg-purple-100 text-purple-800',
                emergency: 'bg-red-100 text-red-800'
            };
            return colors[category] || 'bg-gray-100 text-gray-800';
        }

        function getCategoryText(category) {
            const texts = {
                service: 'ì„œë¹„ìŠ¤',
                maintenance: 'ì ê²€',
                event: 'ì´ë²¤íŠ¸',
                policy: 'ì •ì±…',
                emergency: 'ê¸´ê¸‰'
            };
            return texts[category] || category;
        }

        function getImportanceColor(importance) {
            const colors = {
                normal: 'bg-gray-100 text-gray-800',
                important: 'bg-yellow-100 text-yellow-800',
                urgent: 'bg-red-100 text-red-800'
            };
            return colors[importance] || 'bg-gray-100 text-gray-800';
        }

        function getImportanceText(importance) {
            const texts = {
                normal: 'ì¼ë°˜',
                important: 'ì¤‘ìš”',
                urgent: 'ê¸´ê¸‰'
            };
            return texts[importance] || importance;
        }

        function getLangText(lang) {
            const texts = {
                ko: 'ğŸ‡°ğŸ‡· í•œêµ­ì–´',
                en: 'ğŸ‡ºğŸ‡¸ English',
                zh: 'ğŸ‡¨ğŸ‡³ ä¸­æ–‡',
                ja: 'ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª'
            };
            return texts[lang] || lang;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Remove image
        function removeImage() {
            document.getElementById('imageFile').value = '';
            document.getElementById('imageUrl').value = '';
            document.getElementById('imagePreview').classList.add('hidden');
        }

        // Switch video tab
        function switchVideoTab(tab) {
            const fileTab = document.getElementById('videoFileTab');
            const urlTab = document.getElementById('videoUrlTab');
            const fileBtn = document.getElementById('videoFileTabBtn');
            const urlBtn = document.getElementById('videoUrlTabBtn');
            
            if (tab === 'file') {
                fileTab.classList.remove('hidden');
                urlTab.classList.add('hidden');
                fileBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                fileBtn.classList.add('bg-red-600', 'text-white');
                urlBtn.classList.remove('bg-red-600', 'text-white');
                urlBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            } else {
                fileTab.classList.add('hidden');
                urlTab.classList.remove('hidden');
                urlBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                urlBtn.classList.add('bg-red-600', 'text-white');
                fileBtn.classList.remove('bg-red-600', 'text-white');
                fileBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            }
        }

        // Initialize event listeners after DOM is ready
        function initializeEventListeners() {
            // Image file upload handler
            const imageFileInput = document.getElementById('imageFile');
            if (imageFileInput) {
                console.log('âœ… Image file input found, attaching listener');
                imageFileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            // Save base64 data to hidden input
                            document.getElementById('imageUrl').value = event.target.result;
                            
                            // Show preview
                            document.getElementById('previewImg').src = event.target.result;
                            document.getElementById('imagePreview').classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                    }
                });
            } else {
                console.error('âŒ Image file input not found!');
            }

            // Video file upload handler
            const videoFileInput = document.getElementById('videoFile');
            if (videoFileInput) {
                console.log('âœ… Video file input found, attaching listener');
                videoFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Check file size (max 10MB recommended for localStorage)
                const maxSize = 10 * 1024 * 1024; // 10MB in bytes
                const warningSize = 5 * 1024 * 1024; // 5MB warning
                
                if (file.size > maxSize) {
                    alert('âš ï¸ ë™ì˜ìƒ íŒŒì¼ í¬ê¸°ëŠ” 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní˜„ì¬ íŒŒì¼: ' + (file.size / 1024 / 1024).toFixed(2) + 'MB\n\nğŸ’¡ ê¶Œì¥: YouTubeì— ì—…ë¡œë“œ í›„ URLë¡œ ë“±ë¡í•˜ì„¸ìš”.');
                    this.value = '';
                    return;
                }
                
                if (file.size > warningSize) {
                    if (!confirm('âš ï¸ íŒŒì¼ í¬ê¸°ê°€ í½ë‹ˆë‹¤ (' + (file.size / 1024 / 1024).toFixed(2) + 'MB)\n\nì €ì¥ ì‹œ ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nğŸ’¡ ê¶Œì¥: YouTube URL ì‚¬ìš©')) {
                        this.value = '';
                        return;
                    }
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const videoUrl = event.target.result;
                        const videoSize = videoUrl.length;
                        
                        console.log('Video size:', (videoSize / 1024 / 1024).toFixed(2) + 'MB');
                        
                        document.getElementById('videoFileUrl').value = videoUrl;
                        
                        // Show preview
                        const videoSource = document.getElementById('videoSource');
                        const previewVideo = document.getElementById('previewVideo');
                        
                        videoSource.src = videoUrl;
                        videoSource.type = file.type;
                        previewVideo.load();
                        
                        document.getElementById('videoFilePreview').classList.remove('hidden');
                        
                        // Show size info
                        console.log('âœ… Video uploaded successfully');
                    } catch (error) {
                        console.error('Video upload error:', error);
                        alert('ë™ì˜ìƒ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ' + error.message);
                        e.target.value = '';
                    }
                };
                reader.onerror = function(error) {
                    console.error('FileReader error:', error);
                    alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\në‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    e.target.value = '';
                };
                reader.readAsDataURL(file);
            }
                });
            } else {
                console.error('âŒ Video file input not found!');
            }

            // Form submit handler
            const noticeForm = document.getElementById('noticeForm');
            if (noticeForm) {
                console.log('âœ… Notice form found, attaching submit listener');
                noticeForm.addEventListener('submit', function(e) {
            e.preventDefault();

            try {
                const noticeId = document.getElementById('noticeId').value;
                
                // Get video URL (either from file or URL input)
                const videoFileUrl = document.getElementById('videoFileUrl').value;
                const videoUrlInput = document.getElementById('videoUrl').value;
                const finalVideoUrl = videoFileUrl || videoUrlInput;
                
                // Check localStorage space before saving large video
                if (finalVideoUrl && finalVideoUrl.length > 5000000) { // 5MB in base64
                    if (!confirm('ë™ì˜ìƒ íŒŒì¼ì´ í½ë‹ˆë‹¤ (5MB ì´ìƒ). ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nëŒ€ìš©ëŸ‰ íŒŒì¼ì€ YouTube URL ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤.')) {
                        return;
                    }
                }
                
                // Find existing notice if updating
                let existingNotice = null;
                if (noticeId) {
                    existingNotice = notices.find(n => n.id === parseInt(noticeId));
                }

                const notice = {
                    id: noticeId ? parseInt(noticeId) : Date.now(),
                    title: document.getElementById('title').value,
                    category: document.getElementById('category').value,
                    lang: document.getElementById('lang').value,
                    importance: document.getElementById('importance').value,
                    summary: document.getElementById('summary').value,
                    content: document.getElementById('content').value,
                    imageUrl: document.getElementById('imageUrl').value,
                    videoUrl: finalVideoUrl || '',
                    videoType: videoFileUrl ? 'file' : (videoUrlInput ? 'url' : ''),
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    pinned: document.getElementById('pinned').checked,
                    active: document.getElementById('active').checked,
                    createdAt: existingNotice ? existingNotice.createdAt : new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                if (noticeId && existingNotice) {
                    // Update existing
                    const index = notices.findIndex(n => n.id === parseInt(noticeId));
                    if (index !== -1) {
                        notices[index] = notice;
                    }
                } else {
                    // Add new - Check maximum limit (50 notices)
                    const MAX_NOTICES = 50;
                    if (notices.length >= MAX_NOTICES) {
                        alert(`âš ï¸ ê³µì§€ëŠ” ìµœëŒ€ ${MAX_NOTICES}ê°œê¹Œì§€ë§Œ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\ní˜„ì¬ ê³µì§€ ìˆ˜: ${notices.length}ê°œ\n\nì˜¤ë˜ëœ ê³µì§€ë¥¼ ì‚­ì œí•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`);
                        return;
                    }
                    notices.push(notice);
                }

                // Save to localStorage with error handling
                try {
                    localStorage.setItem('notices', JSON.stringify(notices));
                    alert(`âœ… ê³µì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n\ní˜„ì¬ ê³µì§€ ìˆ˜: ${notices.length}/${50}ê°œ`);
                    resetForm();
                    renderNotices();
                } catch (storageError) {
                    console.error('localStorage error:', storageError);
                    
                    // Rollback if save failed
                    if (!noticeId) {
                        notices.pop();
                    } else if (existingNotice) {
                        const index = notices.findIndex(n => n.id === parseInt(noticeId));
                        if (index !== -1) {
                            notices[index] = existingNotice;
                        }
                    }
                    
                    if (storageError.name === 'QuotaExceededError') {
                        alert('ì €ì¥ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.\n\ní•´ê²° ë°©ë²•:\n1. ì‘ì€ ìš©ëŸ‰ì˜ ë™ì˜ìƒ ì‚¬ìš©\n2. YouTube URLë¡œ ë™ì˜ìƒ ë“±ë¡\n3. ê¸°ì¡´ ê³µì§€ ì¤‘ ì¼ë¶€ ì‚­ì œ');
                    } else {
                        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ' + storageError.message);
                    }
                }
            } catch (error) {
                console.error('Form submission error:', error);
                alert('ê³µì§€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜ ë‚´ìš©: ' + error.message + '\n\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
                });
            } else {
                console.error('âŒ Notice form not found!');
            }
        }

        // Remove video
        function removeVideo() {
            document.getElementById('videoFile').value = '';
            document.getElementById('videoFileUrl').value = '';
            document.getElementById('videoFilePreview').classList.add('hidden');
            
            const previewVideo = document.getElementById('previewVideo');
            previewVideo.pause();
            previewVideo.src = '';
        }

        // Edit notice
        function editNotice(id) {
            const notice = notices.find(n => n.id === id);
            if (!notice) return;

            document.getElementById('noticeId').value = notice.id;
            document.getElementById('title').value = notice.title;
            document.getElementById('category').value = notice.category;
            document.getElementById('lang').value = notice.lang;
            document.getElementById('importance').value = notice.importance;
            document.getElementById('summary').value = notice.summary;
            document.getElementById('content').value = notice.content;
            document.getElementById('imageUrl').value = notice.imageUrl || '';
            document.getElementById('startDate').value = notice.startDate || '';
            document.getElementById('endDate').value = notice.endDate || '';
            document.getElementById('pinned').checked = notice.pinned || false;
            document.getElementById('active').checked = notice.active || false;

            // Show image preview if exists
            if (notice.imageUrl) {
                document.getElementById('previewImg').src = notice.imageUrl;
                document.getElementById('imagePreview').classList.remove('hidden');
            } else {
                document.getElementById('imagePreview').classList.add('hidden');
            }

            // Load video data (safely handle undefined/null)
            if (notice.videoUrl && notice.videoUrl.trim() !== '') {
                if (notice.videoType === 'file') {
                    // Video file upload
                    switchVideoTab('file');
                    document.getElementById('videoFileUrl').value = notice.videoUrl;
                    
                    // Show video preview
                    try {
                        const videoSource = document.getElementById('videoSource');
                        const previewVideo = document.getElementById('previewVideo');
                        videoSource.src = notice.videoUrl;
                        previewVideo.load();
                        document.getElementById('videoFilePreview').classList.remove('hidden');
                    } catch (e) {
                        console.error('Video preview error:', e);
                    }
                } else if (notice.videoType === 'url') {
                    // YouTube URL
                    switchVideoTab('url');
                    document.getElementById('videoUrl').value = notice.videoUrl;
                }
            } else {
                // No video, reset
                switchVideoTab('file');
                document.getElementById('videoUrl').value = '';
                document.getElementById('videoFileUrl').value = '';
                document.getElementById('videoFilePreview').classList.add('hidden');
            }

            document.getElementById('formTitle').textContent = 'ê³µì§€ ìˆ˜ì •';
            document.querySelector('form button[type="submit"]').innerHTML = '<i class="fas fa-save mr-2"></i>ìˆ˜ì •';
            
            // Scroll to form
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Delete notice
        function deleteNotice(id) {
            if (!confirm('ì´ ê³µì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            notices = notices.filter(n => n.id !== id);
            localStorage.setItem('notices', JSON.stringify(notices));
            
            alert('ê³µì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            renderNotices();
        }

        // Reset form
        function resetForm() {
            document.getElementById('noticeForm').reset();
            document.getElementById('noticeId').value = '';
            document.getElementById('imageUrl').value = '';
            document.getElementById('imagePreview').classList.add('hidden');
            
            // Reset video
            document.getElementById('videoFile').value = '';
            document.getElementById('videoFileUrl').value = '';
            document.getElementById('videoUrl').value = '';
            document.getElementById('videoFilePreview').classList.add('hidden');
            switchVideoTab('file'); // Reset to file tab
            
            document.getElementById('formTitle').textContent = 'ê³µì§€ ë“±ë¡';
            document.querySelector('form button[type="submit"]').innerHTML = '<i class="fas fa-save mr-2"></i>ì €ì¥';
        }

        // Initialize
        if (checkAuth()) {
            // Initialize event listeners first
            console.log('ğŸš€ Initializing event listeners...');
            initializeEventListeners();
            
            // Load from localStorage FIRST (priority)
            const savedNotices = localStorage.getItem('notices');
            if (savedNotices) {
                try {
                    notices = JSON.parse(savedNotices);
                    console.log('âœ… Loaded', notices.length, 'notices from localStorage');
                } catch (error) {
                    console.error('Error parsing saved notices:', error);
                    notices = [];
                }
            }
            
            // Render immediately with localStorage data
            renderNotices();
            
            // Then try to load from JSON file (fallback only if localStorage is empty)
            if (notices.length === 0) {
                loadNotices();
            }
        }
    </script>
</body>
</html>
